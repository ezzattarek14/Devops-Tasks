pipeline {
    agent any

    environment {
        IMAGE_NAME = "spring-petclinic"
        IMAGE_TAG  = "latest"
        REGISTRY   = "localhost:8083"
    }

stage('SonarQube Analysis') {
    steps {
        withSonarQubeEnv('MySonarQube') {
            sh 'mvn clean verify sonar:sonar'
        }
    }
}


    stages {
        stage('Run Container') {
            steps {
                script {
                   
                    sh "docker run -d --name petclinic -p 8082:8080 ${IMAGE_NAME}:${IMAGE_TAG}"
                }
            }
        }

        stage('Push to Nexus') {
            steps {
                script {
                    sh """
                        docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
                        echo 'Logging in to Nexus...'
                        docker login localhost:8083 -u admin -p 80d2e66b-8d40-402f-9612-6c12e1cb6a1d
                        docker push ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished!'
        }
        failure {
            echo 'Pipeline failed ❌'
        }
        success {
            echo 'Pipeline succeeded ✅'
        }
    }
}
